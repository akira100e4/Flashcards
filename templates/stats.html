<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Statistiche</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Statistiche di Apprendimento</h1>
            <button class="btn btn-secondary" onclick="location.href='/'">‚Üê Torna alla Home</button>
        </header>

        <!-- Statistiche generali -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-value">{{ stats.totale_flashcards }}</div>
                <div class="stat-label">Totale Flashcards</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÅ</div>
                <div class="stat-value">{{ stats.num_categorie }}</div>
                <div class="stat-label">Categorie</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value">{{ stats.con_priorita }}</div>
                <div class="stat-label">Con Priorit√†</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value">{{ stats.totale_tentativi }}</div>
                <div class="stat-label">Tentativi Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-value">{{ "%.1f"|format(stats.percentuale_media) }}%</div>
                <div class="stat-label">Media Successo</div>
            </div>
        </div>

        <!-- Barra di progresso generale -->
        {% if stats.totale_tentativi > 0 %}
        <div class="general-progress">
            <h3>Livello di Preparazione Generale</h3>
            <div class="progress-bar-container">
                <div class="progress-bar-fill {% if stats.percentuale_media >= 80 %}excellent{% elif stats.percentuale_media >= 60 %}good{% else %}needs-work{% endif %}" 
                     style="width: {{ stats.percentuale_media }}%">
                    <span class="progress-percentage">{{ "%.1f"|format(stats.percentuale_media) }}%</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Statistiche per categoria -->
        {% if stats_per_categoria %}
        <div class="flashcards-section">
            <h2>üìÅ Statistiche per Categoria</h2>
            <div class="category-stats-grid">
                {% for cat, cat_stats in stats_per_categoria.items() %}
                <div class="category-stat-card {% if cat_stats.percentuale_media >= 80 %}excellent{% elif cat_stats.percentuale_media >= 60 %}good{% elif cat_stats.studiate > 0 %}needs-work{% else %}not-studied{% endif %}">
                    <div class="category-stat-header">
                        <h3>{{ cat }}</h3>
                        <span class="category-count">{{ cat_stats.totale }} flashcards</span>
                    </div>
                    <div class="category-stat-data">
                        <div class="stat-detail">
                            <span class="stat-label">Studiate:</span>
                            <span class="stat-value">{{ cat_stats.studiate }}/{{ cat_stats.totale }}</span>
                        </div>
                        <div class="stat-detail">
                            <span class="stat-label">Con priorit√†:</span>
                            <span class="stat-value">{{ cat_stats.con_priorita }}</span>
                        </div>
                        {% if cat_stats.studiate > 0 %}
                        <div class="stat-detail">
                            <span class="stat-label">Successo medio:</span>
                            <span class="stat-value {% if cat_stats.percentuale_media >= 80 %}success{% elif cat_stats.percentuale_media >= 60 %}warning{% else %}error{% endif %}">
                                {{ "%.1f"|format(cat_stats.percentuale_media) }}%
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    {% if cat_stats.studiate > 0 %}
                    <div class="mini-progress">
                        <div class="mini-progress-fill {% if cat_stats.percentuale_media >= 80 %}excellent{% elif cat_stats.percentuale_media >= 60 %}good{% else %}needs-work{% endif %}" 
                             style="width: {{ cat_stats.percentuale_media }}%"></div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Filtri -->
        <div class="stats-filters">
            <label>Filtra per categoria:</label>
            <select id="categoryFilter" onchange="filterByCategory()">
                <option value="">Tutte le categorie</option>
                {% for cat in categorie %}
                <option value="{{ cat }}">{{ cat }}</option>
                {% endfor %}
            </select>
            
            <label>Ordina per:</label>
            <select id="sortSelect" onchange="sortFlashcards()">
                <option value="difficulty">Pi√π difficili</option>
                <option value="easiest">Pi√π facili</option>
                <option value="most-studied">Pi√π studiate</option>
                <option value="alphabetical">Alfabetico</option>
            </select>
        </div>

        <!-- Lista dettagliata -->
        <div class="flashcards-section">
            <h2>Dettaglio Flashcards</h2>
            <div class="stats-list" id="statsList">
                {% if flashcards %}
                    {% for card in flashcards %}
                    <div class="stat-item {% if card.totale > 0 %}{% if card.percentuale >= 80 %}excellent{% elif card.percentuale >= 60 %}good{% else %}needs-work{% endif %}{% else %}not-studied{% endif %}"
                         data-tedesco="{{ card.tedesco }}"
                         data-percentage="{{ card.percentuale }}"
                         data-total="{{ card.totale }}"
                         data-categoria="{{ card.categoria }}">
                        <div class="stat-item-header">
                            <span class="priority-icon">{% if card.priorita %}‚≠ê{% endif %}</span>
                            <span class="category-badge-small">{{ card.categoria }}</span>
                            <div class="stat-item-words">
                                <strong>{{ card.tedesco }}</strong>
                                <span class="arrow">‚Üí</span>
                                <span>{{ card.italiano }}</span>
                            </div>
                        </div>
                        <div class="stat-item-data">
                            <div class="stat-detail">
                                <span class="stat-label">Corrette:</span>
                                <span class="stat-value success">{{ card.corrette }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Sbagliate:</span>
                                <span class="stat-value error">{{ card.sbagliate }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Totale:</span>
                                <span class="stat-value">{{ card.totale }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Successo:</span>
                                <span class="stat-value {% if card.totale > 0 %}{% if card.percentuale >= 80 %}success{% elif card.percentuale >= 60 %}warning{% else %}error{% endif %}{% endif %}">
                                    {% if card.totale > 0 %}{{ "%.1f"|format(card.percentuale) }}%{% else %}-{% endif %}
                                </span>
                            </div>
                        </div>
                        {% if card.totale > 0 %}
                        <div class="mini-progress">
                            <div class="mini-progress-fill {% if card.percentuale >= 80 %}excellent{% elif card.percentuale >= 60 %}good{% else %}needs-work{% endif %}" 
                                 style="width: {{ card.percentuale }}%"></div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>Nessuna statistica disponibile.</p>
                        <p>Inizia a studiare per vedere i tuoi progressi!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function filterByCategory() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const items = document.querySelectorAll('.stat-item');

            items.forEach(item => {
                const categoria = item.dataset.categoria;
                const matches = !categoryFilter || categoria === categoryFilter;
                item.style.display = matches ? 'block' : 'none';
            });
        }

        function sortFlashcards() {
            const sortBy = document.getElementById('sortSelect').value;
            const list = document.getElementById('statsList');
            const items = Array.from(list.querySelectorAll('.stat-item'));

            items.sort((a, b) => {
                switch(sortBy) {
                    case 'difficulty':
                        const aTotal = parseInt(a.dataset.total);
                        const bTotal = parseInt(b.dataset.total);
                        if (aTotal === 0 && bTotal === 0) return 0;
                        if (aTotal === 0) return 1;
                        if (bTotal === 0) return -1;
                        return parseFloat(a.dataset.percentage) - parseFloat(b.dataset.percentage);
                    
                    case 'easiest':
                        const aTotalE = parseInt(a.dataset.total);
                        const bTotalE = parseInt(b.dataset.total);
                        if (aTotalE === 0 && bTotalE === 0) return 0;
                        if (aTotalE === 0) return 1;
                        if (bTotalE === 0) return -1;
                        return parseFloat(b.dataset.percentage) - parseFloat(a.dataset.percentage);
                    
                    case 'most-studied':
                        return parseInt(b.dataset.total) - parseInt(a.dataset.total);
                    
                    case 'alphabetical':
                        return a.dataset.tedesco.localeCompare(b.dataset.tedesco);
                    
                    default:
                        return 0;
                }
            });

            items.forEach(item => list.appendChild(item));
        }
    </script>

    <style>
        .category-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .category-stat-card {
            background: white;
            border: 2px solid var(--light-gray);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }

        .category-stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .category-stat-card.excellent {
            border-color: var(--primary);
            background: linear-gradient(135deg, #d5f4e6 0%, #ffffff 100%);
        }

        .category-stat-card.good {
            border-color: var(--warning);
            background: linear-gradient(135deg, #fff3cd 0%, #ffffff 100%);
        }

        .category-stat-card.needs-work {
            border-color: var(--danger);
            background: linear-gradient(135deg, #f8d7da 0%, #ffffff 100%);
        }

        .category-stat-card.not-studied {
            border-color: var(--gray);
            opacity: 0.7;
        }

        .category-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
        }

        .category-stat-header h3 {
            margin: 0;
            color: var(--dark);
        }

        .category-count {
            background: var(--light-gray);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark);
        }

        .category-stat-data {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .category-badge-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 10px;
        }
    </style>
</body>
</html>