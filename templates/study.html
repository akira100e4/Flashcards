<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📚 Modalità Studio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="study-page">
        <div class="study-container">
            <!-- Barra progresso -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            
            <div class="progress-text" id="progressText">Caricamento...</div>

            <!-- Card display -->
            <div class="card-display" id="cardDisplay">
                <div class="card-type" id="cardType"></div>
                <div class="category-badge" id="categoryBadge" style="margin-bottom: 20px;"></div>
                
                <div class="card-question-container" id="questionContainer">
                    <div class="card-question" id="cardQuestion"></div>
                    <button class="audio-btn" id="questionAudioBtn" onclick="playQuestionAudio()" style="display: none;">
                        🔊
                    </button>
                </div>

                <div class="card-separator" id="separator" style="display: none;"></div>

                <div class="card-answer-container" id="answerContainer" style="display: none;">
                    <div class="card-answer" id="cardAnswer"></div>
                    <button class="audio-btn" id="answerAudioBtn" onclick="playAnswerAudio()" style="display: none;">
                        🔊
                    </button>
                </div>
            </div>

            <!-- Controlli -->
            <div class="study-controls">
                <button class="btn btn-primary btn-large" id="showAnswerBtn" onclick="showAnswer()">
                    👁️ Mostra Risposta
                </button>

                <div class="answer-buttons" id="answerButtons" style="display: none;">
                    <button class="btn btn-danger" onclick="registerAnswer(false)">
                        ❌ Sbagliata
                    </button>
                    <button class="btn btn-success" onclick="registerAnswer(true)">
                        ✅ Corretta
                    </button>
                </div>

                <button class="btn btn-secondary" onclick="location.href='/'">
                    ← Torna alla Home
                </button>

                <div class="study-shortcuts">
                    Scorciatoie: <strong>Spazio</strong> = Mostra risposta | 
                    <strong>←</strong> = Sbagliata | <strong>→</strong> = Corretta
                </div>
            </div>
        </div>
    </div>

    <!-- Summary screen (nascosto inizialmente) -->
    <div class="summary-screen" id="summaryScreen" style="display: none;">
        <div class="summary-content">
            <h1>🎉 Sessione Completata!</h1>
            
            <div class="summary-stats">
                <h2>I tuoi risultati</h2>
                <div class="result-item">
                    <span>Risposte corrette:</span>
                    <strong id="correctCount">0</strong>
                </div>
                <div class="result-item">
                    <span>Risposte sbagliate:</span>
                    <strong id="wrongCount" style="color: #e74c3c;">0</strong>
                </div>
                <div class="result-item">
                    <span>Totale:</span>
                    <strong id="totalCount">0</strong>
                </div>
                <div class="result-item">
                    <span>Percentuale:</span>
                    <strong id="percentage">0%</strong>
                </div>
            </div>

            <div class="motivational-message" id="motivationalMsg"></div>

            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                <button class="btn btn-primary btn-large" onclick="location.href='/'">
                    🏠 Home
                </button>
                <button class="btn btn-secondary btn-large" onclick="location.href='/stats'">
                    📊 Statistiche
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentCard = null;
        let answerShown = false;

        // Carica la prima flashcard
        async function loadCurrentCard() {
            try {
                const response = await fetch('/api/study/current');
                const data = await response.json();

                if (data.completed) {
                    showSummary(data.corrette, data.totale);
                    return;
                }

                currentCard = data;
                answerShown = false;

                // Aggiorna UI
                document.getElementById('progressText').textContent = 
                    `Flashcard ${data.indice + 1} di ${data.totale}`;
                
                const progress = ((data.indice) / data.totale) * 100;
                document.getElementById('progressBar').style.width = progress + '%';

                document.getElementById('cardType').textContent = 
                    data.lingua_domanda === 'de' ? '🇩🇪 Tedesco → 🇮🇹 Italiano' : '🇮🇹 Italiano → 🇩🇪 Tedesco';
                
                document.getElementById('categoryBadge').textContent = data.categoria;
                document.getElementById('cardQuestion').textContent = data.domanda;

                // Mostra pulsante audio per la domanda
                document.getElementById('questionAudioBtn').style.display = 'flex';

                // Nascondi risposta
                document.getElementById('separator').style.display = 'none';
                document.getElementById('answerContainer').style.display = 'none';
                document.getElementById('cardAnswer').textContent = data.risposta;

                // Mostra pulsante "Mostra Risposta"
                document.getElementById('showAnswerBtn').style.display = 'block';
                document.getElementById('answerButtons').style.display = 'none';

            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nel caricamento della flashcard');
            }
        }

        function showAnswer() {
            if (!currentCard || answerShown) return;

            answerShown = true;

            // Mostra risposta
            document.getElementById('separator').style.display = 'block';
            document.getElementById('answerContainer').style.display = 'flex';
            document.getElementById('answerAudioBtn').style.display = 'flex';

            // Nascondi pulsante "Mostra Risposta" e mostra pulsanti di valutazione
            document.getElementById('showAnswerBtn').style.display = 'none';
            document.getElementById('answerButtons').style.display = 'flex';
        }

        async function registerAnswer(correct) {
            if (!answerShown) return;

            try {
                const response = await fetch('/api/study/answer', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({corretta: correct})
                });

                const data = await response.json();

                if (data.completed) {
                    showSummary(data.corrette, data.totale);
                } else {
                    loadCurrentCard();
                }

            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nella registrazione della risposta');
            }
        }

        function playQuestionAudio() {
            if (!currentCard) return;
            playAudio(currentCard.lingua_domanda, currentCard.domanda);
        }

        function playAnswerAudio() {
            if (!currentCard) return;
            playAudio(currentCard.lingua_risposta, currentCard.risposta);
        }

        function playAudio(lang, text) {
            if (!('speechSynthesis' in window)) {
                alert('Il tuo browser non supporta la sintesi vocale');
                return;
            }

            speechSynthesis.cancel();

            const langCode = lang === 'de' ? 'de-DE' : 'it-IT';
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;

            utterance.onerror = function(error) {
                console.error('Errore sintesi vocale:', error);
            };

            speechSynthesis.speak(utterance);
        }

        function showSummary(correct, total) {
            const wrong = total - correct;
            const percentage = total > 0 ? (correct / total * 100).toFixed(1) : 0;

            document.querySelector('.study-page').style.display = 'none';
            document.getElementById('summaryScreen').style.display = 'flex';

            document.getElementById('correctCount').textContent = correct;
            document.getElementById('wrongCount').textContent = wrong;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('percentage').textContent = percentage + '%';

            // Messaggio motivazionale
            let message = '';
            if (percentage >= 90) {
                message = '🌟 Eccellente! Sei un campione!';
            } else if (percentage >= 70) {
                message = '👏 Ottimo lavoro! Continua così!';
            } else if (percentage >= 50) {
                message = '💪 Buon inizio! Continua a esercitarti!';
            } else {
                message = '📚 Non mollare! La pratica rende perfetti!';
            }
            document.getElementById('motivationalMsg').textContent = message;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && !answerShown) {
                e.preventDefault();
                showAnswer();
            } else if (e.code === 'ArrowLeft' && answerShown) {
                e.preventDefault();
                registerAnswer(false);
            } else if (e.code === 'ArrowRight' && answerShown) {
                e.preventDefault();
                registerAnswer(true);
            }
        });

        // Carica la prima card all'avvio
        loadCurrentCard();
    </script>
</body>
</html>