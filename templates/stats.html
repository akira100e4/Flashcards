<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Statistiche</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Stili per le categorie */
        .category-stats-section {
            margin: 40px 0;
        }

        .category-stats-section h2 {
            color: var(--dark);
            margin-bottom: 20px;
        }

        .category-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .category-stat-card {
            background: var(--white);
            border: 2px solid var(--light-gray);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s;
        }

        .category-stat-card:hover {
            border-color: var(--secondary);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }

        .category-stat-card h3 {
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
        }

        .category-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .category-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .category-stat-row span {
            color: var(--gray);
        }

        .category-stat-row strong {
            font-size: 1.1rem;
        }

        .category-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 10px;
        }

        .stats-filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .stats-filters label {
            font-weight: 600;
            color: var(--dark);
        }

        .stats-filters select {
            padding: 10px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            background: white;
            transition: border-color 0.3s;
        }

        .stats-filters select:focus {
            outline: none;
            border-color: var(--secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Statistiche di Apprendimento</h1>
            <button class="btn btn-secondary" onclick="location.href='/'">‚Üê Torna alla Home</button>
        </header>

        <!-- Statistiche generali -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-value">{{ stats.totale_flashcards }}</div>
                <div class="stat-label">Totale Flashcards</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value">{{ stats.con_priorita }}</div>
                <div class="stat-label">Con Priorit√†</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value">{{ stats.totale_tentativi }}</div>
                <div class="stat-label">Tentativi Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-value">{{ "%.1f"|format(stats.percentuale_media) }}%</div>
                <div class="stat-label">Media Successo</div>
            </div>
        </div>

        <!-- Barra di progresso generale -->
        {% if stats.totale_tentativi > 0 %}
        <div class="general-progress">
            <h3>Livello di Preparazione Generale</h3>
            <div class="progress-bar-container">
                <div class="progress-bar-fill {% if stats.percentuale_media >= 80 %}excellent{% elif stats.percentuale_media >= 60 %}good{% else %}needs-work{% endif %}" 
                     style="width: {{ stats.percentuale_media }}%">
                    <span class="progress-percentage">{{ "%.1f"|format(stats.percentuale_media) }}%</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Distribuzione per difficolt√† -->
        <div class="difficulty-distribution">
            <h3>üìä Distribuzione per Difficolt√†</h3>
            <div class="difficulty-stats-grid">
                <div class="difficulty-stat-card non-studiate">
                    <div class="difficulty-icon">üìù</div>
                    <div class="difficulty-count">
                        {{ flashcards | selectattr('totale', 'equalto', 0) | list | length }}
                    </div>
                    <div class="difficulty-label">Non studiate</div>
                </div>
                <div class="difficulty-stat-card difficili">
                    <div class="difficulty-icon">üò∞</div>
                    <div class="difficulty-count">
                        {{ flashcards | selectattr('totale', 'gt', 0) | selectattr('percentuale', 'lt', 50) | list | length }}
                    </div>
                    <div class="difficulty-label">Difficili (&lt;50%)</div>
                </div>
                <div class="difficulty-stat-card medie">
                    <div class="difficulty-icon">ü§î</div>
                    <div class="difficulty-count">
                        {{ flashcards | selectattr('totale', 'gt', 0) | selectattr('percentuale', 'ge', 50) | selectattr('percentuale', 'lt', 80) | list | length }}
                    </div>
                    <div class="difficulty-label">Medie (50-79%)</div>
                </div>
                <div class="difficulty-stat-card facili">
                    <div class="difficulty-icon">‚úÖ</div>
                    <div class="difficulty-count">
                        {{ flashcards | selectattr('totale', 'gt', 0) | selectattr('percentuale', 'ge', 80) | list | length }}
                    </div>
                    <div class="difficulty-label">Facili (‚â•80%)</div>
                </div>
            </div>
        </div>

        <!-- Statistiche per Categoria -->
        {% if stats_categorie %}
        <div class="category-stats-section">
            <h2>üìÇ Statistiche per Categoria</h2>
            <div class="category-stats-grid">
                {% for categoria, cat_stats in stats_categorie.items() %}
                <div class="category-stat-card">
                    <h3>{{ categoria }}</h3>
                    <div class="category-details">
                        <div class="category-stat-row">
                            <span>Flashcards:</span>
                            <strong>{{ cat_stats.totale_flashcards }}</strong>
                        </div>
                        <div class="category-stat-row">
                            <span>Studiate:</span>
                            <strong class="success">{{ cat_stats.studiate }}</strong>
                        </div>
                        <div class="category-stat-row">
                            <span>Non studiate:</span>
                            <strong class="warning">{{ cat_stats.non_studiate }}</strong>
                        </div>
                        {% if cat_stats.totale_tentativi > 0 %}
                        <div class="category-stat-row">
                            <span>Tentativi:</span>
                            <strong>{{ cat_stats.totale_tentativi }}</strong>
                        </div>
                        <div class="category-stat-row">
                            <span>Corrette:</span>
                            <strong class="success">{{ cat_stats.corrette_totali }}</strong>
                        </div>
                        <div class="category-stat-row">
                            <span>Sbagliate:</span>
                            <strong class="error">{{ cat_stats.sbagliate_totali }}</strong>
                        </div>
                        <div class="category-stat-row">
                            <span>Successo:</span>
                            <strong class="{% if cat_stats.percentuale_media >= 80 %}success{% elif cat_stats.percentuale_media >= 60 %}warning{% else %}error{% endif %}">
                                {{ "%.1f"|format(cat_stats.percentuale_media) }}%
                            </strong>
                        </div>
                        <div class="mini-progress">
                            <div class="mini-progress-fill {% if cat_stats.percentuale_media >= 80 %}excellent{% elif cat_stats.percentuale_media >= 60 %}good{% else %}needs-work{% endif %}" 
                                 style="width: {{ cat_stats.percentuale_media }}%"></div>
                        </div>
                        {% else %}
                        <div class="category-stat-row">
                            <span class="warning">Nessuna flashcard studiata in questa categoria</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Filtri -->
        <div class="stats-filters">
            <label>
                Categoria:
            </label>
            <select id="categoryFilter" onchange="filterByCategory()">
                <option value="tutte">Tutte le categorie</option>
                {% for categoria in categorie %}
                <option value="{{ categoria }}">{{ categoria }}</option>
                {% endfor %}
            </select>
            
            <label>
                Ordina per:
            </label>
            <select id="sortSelect" onchange="sortFlashcards()">
                <option value="difficulty">Pi√π difficili</option>
                <option value="easiest">Pi√π facili</option>
                <option value="most-studied">Pi√π studiate</option>
                <option value="alphabetical">Alfabetico</option>
            </select>
        </div>

        <!-- Lista dettagliata -->
        <div class="flashcards-section">
            <h2>Dettaglio Flashcards</h2>
            <div class="stats-list" id="statsList">
                {% if flashcards %}
                    {% for card in flashcards %}
                    <div class="stat-item {% if card.totale > 0 %}{% if card.percentuale >= 80 %}excellent{% elif card.percentuale >= 60 %}good{% else %}needs-work{% endif %}{% else %}not-studied{% endif %}"
                         data-tedesco="{{ card.tedesco }}"
                         data-categoria="{{ card.categoria }}"
                         data-percentage="{{ card.percentuale }}"
                         data-total="{{ card.totale }}">
                        <div class="stat-item-header">
                            <span class="priority-icon">{% if card.priorita %}‚≠ê{% endif %}</span>
                            <div class="stat-item-words">
                                <span class="category-badge">{{ card.categoria }}</span>
                                <strong>{{ card.tedesco }}</strong>
                                <span class="arrow">‚Üí</span>
                                <span>{{ card.italiano }}</span>
                            </div>
                        </div>
                        <div class="stat-item-data">
                            <div class="stat-detail">
                                <span class="stat-label">Corrette:</span>
                                <span class="stat-value success">{{ card.corrette }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Sbagliate:</span>
                                <span class="stat-value error">{{ card.sbagliate }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Totale:</span>
                                <span class="stat-value">{{ card.totale }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Successo:</span>
                                <span class="stat-value {% if card.totale > 0 %}{% if card.percentuale >= 80 %}success{% elif card.percentuale >= 60 %}warning{% else %}error{% endif %}{% endif %}">
                                    {% if card.totale > 0 %}{{ "%.1f"|format(card.percentuale) }}%{% else %}-{% endif %}
                                </span>
                            </div>
                        </div>
                        {% if card.totale > 0 %}
                        <div class="mini-progress">
                            <div class="mini-progress-fill {% if card.percentuale >= 80 %}excellent{% elif card.percentuale >= 60 %}good{% else %}needs-work{% endif %}" 
                                 style="width: {{ card.percentuale }}%"></div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>Nessuna statistica disponibile.</p>
                        <p>Inizia a studiare per vedere i tuoi progressi!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function filterByCategory() {
            const categoria = document.getElementById('categoryFilter').value;
            const items = document.querySelectorAll('.stat-item');

            items.forEach(item => {
                if (categoria === 'tutte' || item.dataset.categoria === categoria) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function sortFlashcards() {
            const sortBy = document.getElementById('sortSelect').value;
            const list = document.getElementById('statsList');
            const items = Array.from(list.querySelectorAll('.stat-item'));

            items.sort((a, b) => {
                switch(sortBy) {
                    case 'difficulty':
                        const aTotal = parseInt(a.dataset.total);
                        const bTotal = parseInt(b.dataset.total);
                        if (aTotal === 0 && bTotal === 0) return 0;
                        if (aTotal === 0) return 1;
                        if (bTotal === 0) return -1;
                        return parseFloat(a.dataset.percentage) - parseFloat(b.dataset.percentage);
                    
                    case 'easiest':
                        const aTotalE = parseInt(a.dataset.total);
                        const bTotalE = parseInt(b.dataset.total);
                        if (aTotalE === 0 && bTotalE === 0) return 0;
                        if (aTotalE === 0) return 1;
                        if (bTotalE === 0) return -1;
                        return parseFloat(b.dataset.percentage) - parseFloat(a.dataset.percentage);
                    
                    case 'most-studied':
                        return parseInt(b.dataset.total) - parseInt(a.dataset.total);
                    
                    case 'alphabetical':
                        return a.dataset.tedesco.localeCompare(b.dataset.tedesco);
                    
                    default:
                        return 0;
                }
            });

            items.forEach(item => list.appendChild(item));
        }
    </script>
</body>
</html>