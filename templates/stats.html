<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Statistiche</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            margin-right: 10px;
        }
        
        .category-stats-section {
            margin-bottom: 40px;
        }
        
        .category-stat-card {
            background: var(--light-gray);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .category-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .category-stat-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark);
        }
        
        .category-mini-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .category-mini-stat {
            text-align: center;
        }
        
        .category-mini-stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .category-mini-stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Statistiche di Apprendimento</h1>
            <button class="btn btn-secondary" onclick="location.href='/'">‚Üê Torna alla Home</button>
        </header>

        <!-- Statistiche generali -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">üìö</div>
                <div class="stat-value">{{ stats.totale_flashcards }}</div>
                <div class="stat-label">Totale Flashcards</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè∑Ô∏è</div>
                <div class="stat-value">{{ stats.totale_categorie }}</div>
                <div class="stat-label">Categorie</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-value">{{ stats.con_priorita }}</div>
                <div class="stat-label">Con Priorit√†</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value">{{ stats.totale_tentativi }}</div>
                <div class="stat-label">Tentativi Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-value">{{ "%.1f"|format(stats.percentuale_media or 0) }}%</div>
                <div class="stat-label">Media Successo</div>
            </div>
        </div>

        <!-- Barra di progresso generale -->
        {% if stats.totale_tentativi > 0 %}
        <div class="general-progress">
            <h3>Livello di Preparazione Generale</h3>
            <div class="progress-bar-container">
                {% set perc_media = stats.percentuale_media or 0 %}
                <div class="progress-bar-fill {% if perc_media >= 80 %}excellent{% elif perc_media >= 60 %}good{% else %}needs-work{% endif %}" 
                     style="width: {{ perc_media }}%">
                    <span class="progress-percentage">{{ "%.1f"|format(perc_media) }}%</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Statistiche per categoria -->
        {% if categorie_stats %}
        <div class="category-stats-section">
            <h2>üìÇ Statistiche per Categoria</h2>
            {% for categoria, stats_cat in categorie_stats.items() %}
            <div class="category-stat-card">
                <div class="category-stat-header">
                    <span class="category-stat-title">{{ categoria }}</span>
                </div>
                <div class="category-mini-stats">
                    <div class="category-mini-stat">
                        <div class="category-mini-stat-value">{{ stats_cat.totale }}</div>
                        <div class="category-mini-stat-label">Flashcards</div>
                    </div>
                    <div class="category-mini-stat">
                        <div class="category-mini-stat-value">{{ stats_cat.con_priorita }}</div>
                        <div class="category-mini-stat-label">Priorit√†</div>
                    </div>
                    <div class="category-mini-stat">
                        <div class="category-mini-stat-value">{{ stats_cat.totale_tentativi }}</div>
                        <div class="category-mini-stat-label">Tentativi</div>
                    </div>
                    <div class="category-mini-stat">
                        {% set perc_cat = stats_cat.percentuale_media or 0 %}
                        <div class="category-mini-stat-value" style="color: {{ 'var(--primary)' if perc_cat >= 80 else 'var(--warning)' if perc_cat >= 60 else 'var(--danger)' }}">
                            {{ "%.1f"|format(perc_cat) }}%
                        </div>
                        <div class="category-mini-stat-label">Successo</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Filtri -->
        <div class="stats-filters">
            <label>
                Ordina per:
            </label>
            <select id="sortSelect" onchange="sortFlashcards()">
                <option value="difficulty">Pi√π difficili</option>
                <option value="easiest">Pi√π facili</option>
                <option value="most-studied">Pi√π studiate</option>
                <option value="alphabetical">Alfabetico</option>
                <option value="category">Per Categoria</option>
            </select>
        </div>

        <!-- Lista dettagliata -->
        <div class="flashcards-section">
            <h2>Dettaglio Flashcards</h2>
            <div class="stats-list" id="statsList">
                {% if flashcards %}
                    {% for card in flashcards %}
                    {% set card_perc = card.percentuale or 0 %}
                    <div class="stat-item {% if card.totale > 0 %}{% if card_perc >= 80 %}excellent{% elif card_perc >= 60 %}good{% else %}needs-work{% endif %}{% else %}not-studied{% endif %}"
                         data-tedesco="{{ card.tedesco }}"
                         data-categoria="{{ card.categoria or 'Senza categoria' }}"
                         data-percentage="{{ card_perc }}"
                         data-total="{{ card.totale }}">
                        <div class="stat-item-header">
                            <span class="priority-icon">{% if card.priorita %}‚≠ê{% endif %}</span>
                            <span class="category-badge" data-categoria="{{ card.categoria or 'Senza categoria' }}">{{ card.categoria or 'Senza categoria' }}</span>
                            <div class="stat-item-words">
                                <strong>{{ card.tedesco }}</strong>
                                <span class="arrow">‚Üí</span>
                                <span>{{ card.italiano }}</span>
                            </div>
                        </div>
                        <div class="stat-item-data">
                            <div class="stat-detail">
                                <span class="stat-label">Corrette:</span>
                                <span class="stat-value success">{{ card.corrette }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Sbagliate:</span>
                                <span class="stat-value error">{{ card.sbagliate }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Totale:</span>
                                <span class="stat-value">{{ card.totale }}</span>
                            </div>
                            <div class="stat-detail">
                                <span class="stat-label">Successo:</span>
                                <span class="stat-value {% if card.totale > 0 %}{% if card_perc >= 80 %}success{% elif card_perc >= 60 %}warning{% else %}error{% endif %}{% endif %}">
                                    {% if card.totale > 0 %}{{ "%.1f"|format(card_perc) }}%{% else %}-{% endif %}
                                </span>
                            </div>
                        </div>
                        {% if card.totale > 0 %}
                        <div class="mini-progress">
                            <div class="mini-progress-fill {% if card_perc >= 80 %}excellent{% elif card_perc >= 60 %}good{% else %}needs-work{% endif %}" 
                                 style="width: {{ card_perc }}%"></div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>Nessuna statistica disponibile.</p>
                        <p>Inizia a studiare per vedere i tuoi progressi!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Colori per le categorie
        const categoryColors = {};
        
        function getCategoryColor(categoria) {
            if (!categoryColors[categoria]) {
                const colors = [
                    '#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#27ae60',
                    '#16a085', '#2980b9', '#8e44ad', '#c0392b', '#d35400'
                ];
                const hash = categoria.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                categoryColors[categoria] = colors[hash % colors.length];
            }
            return categoryColors[categoria];
        }
        
        // Applica colori alle categorie
        document.querySelectorAll('.category-badge').forEach(badge => {
            const categoria = badge.dataset.categoria || badge.textContent.trim();
            badge.style.background = getCategoryColor(categoria);
        });

        function sortFlashcards() {
            const sortBy = document.getElementById('sortSelect').value;
            const list = document.getElementById('statsList');
            const items = Array.from(list.querySelectorAll('.stat-item'));

            items.sort((a, b) => {
                switch(sortBy) {
                    case 'difficulty':
                        const aTotal = parseInt(a.dataset.total);
                        const bTotal = parseInt(b.dataset.total);
                        if (aTotal === 0 && bTotal === 0) return 0;
                        if (aTotal === 0) return 1;
                        if (bTotal === 0) return -1;
                        return parseFloat(a.dataset.percentage) - parseFloat(b.dataset.percentage);
                    
                    case 'easiest':
                        const aTotalE = parseInt(a.dataset.total);
                        const bTotalE = parseInt(b.dataset.total);
                        if (aTotalE === 0 && bTotalE === 0) return 0;
                        if (aTotalE === 0) return 1;
                        if (bTotalE === 0) return -1;
                        return parseFloat(b.dataset.percentage) - parseFloat(a.dataset.percentage);
                    
                    case 'most-studied':
                        return parseInt(b.dataset.total) - parseInt(a.dataset.total);
                    
                    case 'alphabetical':
                        return a.dataset.tedesco.localeCompare(b.dataset.tedesco);
                    
                    case 'category':
                        const catCompare = a.dataset.categoria.localeCompare(b.dataset.categoria);
                        if (catCompare !== 0) return catCompare;
                        return a.dataset.tedesco.localeCompare(b.dataset.tedesco);
                    
                    default:
                        return 0;
                }
            });

            items.forEach(item => list.appendChild(item));
        }
    </script>
</body>
</html>